//
//  XManPageURLComponentsTests.m
//  ManOpenTests
//
//  Created by Don McCaughey on 2/3/18.
//

#import <XCTest/XCTest.h>
#import "XManPageURLComponents.h"
#import "ManPage.h"

@interface XManPageURLComponentsTests : XCTestCase
@end


@implementation XManPageURLComponentsTests

- (void)testInit
{
    XManPageURLComponents *components = [[XManPageURLComponents new] autorelease];
    
    XCTAssertNil(components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

#pragma mark - initWithAproposKeyword:

- (void)testInitWithAproposKeyword
{
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithAproposKeyword:@"print"];
    [components autorelease];
    
    XCTAssertEqualObjects(@"print", components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

- (void)testInitWithAproposKeyword_with_empty_keyword
{
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithAproposKeyword:@""];
    [components autorelease];

    XCTAssertNil(components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

- (void)testInitWithAproposKeyword_with_nil_keyword
{
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithAproposKeyword:nil];
    [components autorelease];

    XCTAssertNil(components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

#pragma mark - -initWithManPages;

- (void)testInitWithManPages
{
    ManPage *grep = [[[ManPage alloc] initWithName:@"grep"] autorelease];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithManPages:@[ grep ]];
    [components autorelease];

    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertNil(components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"grep", components.manPages.firstObject.name);
}

- (void)testInitWithManPages_with_empty_array
{
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithManPages:@[]];
    [components autorelease];

    XCTAssertNil(components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

- (void)testInitWithManPages_with_nil_array
{
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithManPages:nil];
    [components autorelease];

    XCTAssertNil(components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

- (void)testInitWithManPages_with_multiple_pages
{
    ManPage *open = [[ManPage alloc] initWithSection:@"2"
                                             andName:@"open"];
    [open autorelease];
    ManPage *grep = [[[ManPage alloc] initWithName:@"grep"] autorelease];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithManPages:@[ open, grep ]];
    [components autorelease];

    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(2, components.manPages.count);
    XCTAssertEqualObjects(@"2", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"open", components.manPages.firstObject.name);
    XCTAssertNil([components.manPages objectAtIndex:1].section);
    XCTAssertEqualObjects(@"grep", [components.manPages objectAtIndex:1].name);
}

#pragma mark - initWithURL:

- (void)testInitWithURL_with_nil_url
{
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:nil];
    [components autorelease];
    XCTAssertNil(components);
}

- (void)testInitWithURL_with_wrong_url_scheme
{
    NSURL *url = [NSURL URLWithString:@"http://example.com"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components);
}

- (void)testInitWithURL_with_man_page_name
{
    NSURL *url = [NSURL URLWithString:@"x-man-page://grep"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];

    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertNil(components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"grep", components.manPages.firstObject.name);
}

- (void)testInitWithURL_with_man_page_section_and_name
{
    NSURL *url = [NSURL URLWithString:@"x-man-page://1/grep"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];

    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertEqualObjects(@"1", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"grep", components.manPages.firstObject.name);
}

- (void)testInitWithURL_for_man_page_with_varying_slashes
{
    NSURL *url = [NSURL URLWithString:@"x-man-page:3/printf"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertEqualObjects(@"3", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"printf", components.manPages.firstObject.name);

    url = [NSURL URLWithString:@"x-man-page:/basename"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertNil(components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"basename", components.manPages.firstObject.name);

    url = [NSURL URLWithString:@"x-man-page://ed/"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertNil(components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"ed", components.manPages.firstObject.name);

    url = [NSURL URLWithString:@"x-man-page:///2/open"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertEqualObjects(@"2", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"open", components.manPages.firstObject.name);

    url = [NSURL URLWithString:@"x-man-page:///2/close/"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertEqualObjects(@"2", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"close", components.manPages.firstObject.name);

    url = [NSURL URLWithString:@"x-man-page:///sh//"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertNil(components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"sh", components.manPages.firstObject.name);
}

- (void)testInitWithURL_with_man_page_in_section_n
{
    NSURL *url = [NSURL URLWithString:@"x-man-page://n/Tcl"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];

    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertEqualObjects(@"n", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"Tcl", components.manPages.firstObject.name);
}

- (void)testInitWithURL_when_name_begins_with_a_digit
{
    NSURL *url = [NSURL URLWithString:@"x-man-page://2to3"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertNil(components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"2to3", components.manPages.firstObject.name);
    
    url = [NSURL URLWithString:@"x-man-page://7/2to3"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertEqualObjects(@"7", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"2to3", components.manPages.firstObject.name);
}

- (void)testInitWithURL_with_multiple_names
{
    NSURL *url = [NSURL URLWithString:@"x-man-page://grep/printf"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(2, components.manPages.count);
    XCTAssertNil(components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"grep", components.manPages.firstObject.name);
    XCTAssertNil([components.manPages objectAtIndex:1].section);
    XCTAssertEqualObjects(@"printf", [components.manPages objectAtIndex:1].name);

    url = [NSURL URLWithString:@"x-man-page://1/grep/3/printf"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(2, components.manPages.count);
    XCTAssertEqualObjects(@"1", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"grep", components.manPages.firstObject.name);
    XCTAssertEqualObjects(@"3", [components.manPages objectAtIndex:1].section);
    XCTAssertEqualObjects(@"printf", [components.manPages objectAtIndex:1].name);

    url = [NSURL URLWithString:@"x-man-page://1/grep/printf/2/open"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(3, components.manPages.count);
    XCTAssertEqualObjects(@"1", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"grep", components.manPages.firstObject.name);
    XCTAssertNil([components.manPages objectAtIndex:1].section);
    XCTAssertEqualObjects(@"printf", [components.manPages objectAtIndex:1].name);
    XCTAssertEqualObjects(@"2", [components.manPages objectAtIndex:2].section);
    XCTAssertEqualObjects(@"open", [components.manPages objectAtIndex:2].name);
}

- (void)testInitWithURL_for_scheme_capitalization
{
    NSURL *url = [NSURL URLWithString:@"X-MAN-PAGE://find"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertNil(components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"find", components.manPages.firstObject.name);
    
    url = [NSURL URLWithString:@"X-Man-Page://1/find"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components.aproposKeyword);
    XCTAssertEqual(1, components.manPages.count);
    XCTAssertEqualObjects(@"1", components.manPages.firstObject.section);
    XCTAssertEqualObjects(@"find", components.manPages.firstObject.name);
}

- (void)testInitWithURL_for_apropos
{
    NSURL *url = [NSURL URLWithString:@"x-man-page://print;type=a"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertEqualObjects(@"print", components.aproposKeyword);
    XCTAssertNil(components.manPages);
    
    url = [NSURL URLWithString:@"x-man-page://5/print;type=a"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertEqualObjects(@"print", components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

- (void)testInitWithURL_for_apropos_with_varying_slashes
{
    NSURL *url = [NSURL URLWithString:@"x-man-page:/send;type=a"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertEqualObjects(@"send", components.aproposKeyword);
    XCTAssertNil(components.manPages);
    
    url = [NSURL URLWithString:@"x-man-page:///name;type=a"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertEqualObjects(@"name", components.aproposKeyword);
    XCTAssertNil(components.manPages);
    
    url = [NSURL URLWithString:@"x-man-page:///2/file;type=a"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertEqualObjects(@"file", components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

- (void)testInitWithURL_for_apropos_with_multiple_keywords
{
    NSURL *url = [NSURL URLWithString:@"x-man-page:/save/ignored;type=a"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertEqualObjects(@"save", components.aproposKeyword);
    XCTAssertNil(components.manPages);
    
    url = [NSURL URLWithString:@"x-man-page://1/open/ignored;type=a"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    XCTAssertEqualObjects(@"open", components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

- (void)testInitWithURL_for_apropos_keyword_begins_with_digit
{
    NSURL *url = [NSURL URLWithString:@"x-man-page://1/2p;type=a"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertEqualObjects(@"2p", components.aproposKeyword);
    XCTAssertNil(components.manPages);
    
    url = [NSURL URLWithString:@"x-man-page://2p;type=a"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    XCTAssertEqualObjects(@"2p", components.aproposKeyword);
    XCTAssertNil(components.manPages);
}

- (void)testInitWithURL_with_missing_parts
{
    NSURL *url = [NSURL URLWithString:@"x-man-page://"];
    XManPageURLComponents *components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components);
    
    url = [NSURL URLWithString:@"x-man-page:"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components);
    
    url = [NSURL URLWithString:@"x-man-page"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components);
    
    url = [NSURL URLWithString:@"x-man-page://;type=a"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components);
    
    url = [NSURL URLWithString:@"x-man-page:;type=a"];
    components = [[XManPageURLComponents alloc] initWithURL:url];
    [components autorelease];
    XCTAssertNil(components);
}

@end
